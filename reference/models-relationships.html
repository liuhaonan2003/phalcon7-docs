<!DOCTYPE html>

<html lang="en">
<head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>模型关系（Relationships between Models） &mdash; Phalcon7 1.2.1 文档</title>
    <meta name="keywords" content="php, phalcon, phalcon7, phalcon php, php framework, faster php framework">
    <link rel="stylesheet" type="text/css" href="../static/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../static/phalcon.css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="../static/jquery.min.js"></script>
    <link rel="shortcut icon" href="../static/img/favicon.ico"/>
    <link rel="index" title="索引" href="../index.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="top" title="Phalcon7 1.2.1 文档" href="../index.html" />
    <link rel="next" title="模型元数据（Models Meta-Data）" href="models-metadata.html" />
    <link rel="prev" title="使用模型（Working with Models）" href="models.html" /> 
</head>
<body>

<header class="page-header">
<nav class="navbar" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-container">
				<span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
			</button>
			<a class="navbar-brand phalcon-logo" href="/"><span itemprop="name" class="sr-only">Phalcon PHP</span></a>
		</div>

		<div class="collapse navbar-collapse navbar-right" id="main-menu-container">
			<ul class="nav navbar-nav main-menu">
			  <li class="first"><a href="https://github.com/dreamsxin/cphalcon7" class="header-nav-link">GitHub</a></li>
			  <li class="first"><a href="https://github.com/dreamsxin/cphalcon7/releases" class="header-nav-link">Download</a></li>
			  <li class="first"><a href="/api/" class="header-nav-link">API</a></li>
			  <li class="first"><a href="/internals/" class="header-nav-link">内核开发手册</a></li>
			</ul>
		</div>
	</div>
</nav>
</header>

<div class="heading">
    <div class="container">
        <div class="row">
            <h2>Documentation</h2>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="models-metadata.html" title="模型元数据（Models Meta-Data）"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="models.html" title="使用模型（Working with Models）"
             accesskey="P">上一页</a> |</li>
        <li><a href="http://myleftstudio.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon7 1.2.1 文档</a> &raquo;</li> 
      </ul>
    </div>  
</div>

<div class="container-fluid">
	<div class="col-md-3 primary-box">
		<div class="panel panel-default">
			<div class="panel-heading"><a href="../index.html">內容目录</a></div>
			<div class="panel-body"><ul>
<li><a class="reference internal" href="#">模型关系（Relationships between Models）</a><ul>
<li><a class="reference internal" href="#unidirectional-relationships">单向关系（Unidirectional relationships）</a></li>
<li><a class="reference internal" href="#bidirectional-relations">双向关系（Bidirectional relations）</a></li>
<li><a class="reference internal" href="#defining-relationships">定义关系（Defining relationships）</a></li>
<li><a class="reference internal" href="#taking-advantage-of-relationships">使用关系（Taking advantage of relationships）</a></li>
<li><a class="reference internal" href="#aliasing-relationships">定义关系（Aliasing Relationships）</a></li>
<li><a class="reference internal" href="#getters-magic-getters-vs-explicit-methods">魔术方法 Getters 对比显示方法（Magic Getters vs. Explicit methods）</a></li>
<li><a class="reference internal" href="#virtual-foreign-keys">虚拟外键（Virtual Foreign Keys）</a></li>
<li><a class="reference internal" href="#cascade-restrict-actions">级联与限制动作（Cascade/Restrict actions）</a></li>
<li><a class="reference internal" href="#storing-related-records">存储关系记录（Storing related records）</a></li>
<li><a class="reference internal" href="#operations-over-resultsets">在结果集中操作（Operations over Resultsets）</a></li>
<li><a class="reference internal" href="#updating-related-records">更新关联表记录（Updating related records）</a></li>
<li><a class="reference internal" href="#deleting-related-records">删除关联表记录（Deleting related records）</a></li>
</ul>
</li>
</ul>
</div>
			<div class="panel-heading">上一个主题</div>
            <div class="panel-body"><p class="topless"><a href="models.html" title="上一章">&lt; 使用模型（Working with Models）</a></p></div>
			<div class="panel-heading">下一个主题</div>
            <div class="panel-body"><p class="topless"><a href="models-metadata.html" title="下一章">模型元数据（Models Meta-Data） &gt;</a></p></div>
		</div>
	</div>
  <div class="col-md-9 second-box" valign="top">
	<div class="document">
		<div class="documentwrapper">
		  <div class="bodywrapper">
			<div class="body" >
			  
  <div class="section" id="relationships-between-models">
<h1>模型关系（Relationships between Models）<a class="headerlink" href="#relationships-between-models" title="永久链接至标题">¶</a></h1>
<p>There are four types of relationships: one-on-one, one-to-many, many-to-one and many-to-many. The relationship may be
unidirectional or bidirectional, and each can be simple (a one to one model) or more complex (a combination of models).
The model manager manages foreign key constraints for these relationships, the definition of these helps referential
integrity as well as easy and fast access of related records to a model. Through the implementation of relations,
it is easy to access data in related models from each record in a uniform way.</p>
<p>有四种关系类型：1对1,1对多，多对1，多对多。关系可以是单向或者双向的，每个关系可以是简单的（一个1对1的模型）也可以是复杂的（1组模型）。</p>
<div class="section" id="unidirectional-relationships">
<h2>单向关系（Unidirectional relationships）<a class="headerlink" href="#unidirectional-relationships" title="永久链接至标题">¶</a></h2>
<p>Unidirectional relations are those that are generated in relation to one another but not vice versa.</p>
</div>
<div class="section" id="bidirectional-relations">
<h2>双向关系（Bidirectional relations）<a class="headerlink" href="#bidirectional-relations" title="永久链接至标题">¶</a></h2>
<p>The bidirectional relations build relationships in both models and each model defines the inverse relationship of the other.</p>
</div>
<div class="section" id="defining-relationships">
<h2>定义关系（Defining relationships）<a class="headerlink" href="#defining-relationships" title="永久链接至标题">¶</a></h2>
<p>In Phalcon, relationships must be defined in the <code class="code docutils literal"><span class="pre">initialize()</span></code> method of a model. The methods <code class="code docutils literal"><span class="pre">belongsTo()</span></code>, <code class="code docutils literal"><span class="pre">hasOne()</span></code>,
<code class="code docutils literal"><span class="pre">hasMany()</span></code> and <code class="code docutils literal"><span class="pre">hasManyToMany()</span></code> define the relationship between one or more fields from the current model to fields in
another model. Each of these methods requires 3 parameters: local fields, referenced model, referenced fields.</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>hasMany</td>
<td>Defines a 1-n relationship</td>
</tr>
<tr class="row-odd"><td>hasOne</td>
<td>Defines a 1-1 relationship</td>
</tr>
<tr class="row-even"><td>belongsTo</td>
<td>Defines a n-1 relationship</td>
</tr>
<tr class="row-odd"><td>hasManyToMany</td>
<td>Defines a n-n relationship</td>
</tr>
</tbody>
</table>
<p>The following schema shows 3 tables whose relations will serve us as an example regarding relationships:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">robots</span><span class="o">`</span> <span class="p">(</span>
    <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
    <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="k">type</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="k">year</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">robots_parts</span><span class="o">`</span> <span class="p">(</span>
    <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
    <span class="o">`</span><span class="n">robots_id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="n">parts_id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="n">created_at</span><span class="o">`</span> <span class="nb">DATE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
    <span class="k">KEY</span> <span class="o">`</span><span class="n">robots_id</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">robots_id</span><span class="o">`</span><span class="p">),</span>
    <span class="k">KEY</span> <span class="o">`</span><span class="n">parts_id</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">parts_id</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">parts</span><span class="o">`</span> <span class="p">(</span>
    <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
    <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li>The model &#8220;Robots&#8221; has many &#8220;RobotsParts&#8221;.</li>
<li>The model &#8220;Parts&#8221; has many &#8220;RobotsParts&#8221;.</li>
<li>The model &#8220;RobotsParts&#8221; belongs to both &#8220;Robots&#8221; and &#8220;Parts&#8221; models as a many-to-one relation.</li>
<li>The model &#8220;Robots&#8221; has a relation many-to-many to &#8220;Parts&#8221; through &#8220;RobotsParts&#8221;.</li>
</ul>
<p>Check the EER diagram to understand better the relations:</p>
<img class="align-center" src="../static/img/eer-1.png"><p>The models with their relations could be implemented as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;RobotsParts&quot;</span><span class="p">,</span> <span class="s2">&quot;robots_id&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Parts</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;RobotsParts&quot;</span><span class="p">,</span> <span class="s2">&quot;parts_id&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RobotsParts</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$robots_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$parts_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s2">&quot;robots_id&quot;</span><span class="p">,</span> <span class="s2">&quot;Robots&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s2">&quot;parts_id&quot;</span><span class="p">,</span> <span class="s2">&quot;Parts&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first parameter indicates the field of the local model used in the relationship; the second indicates the name
of the referenced model and the third the field name in the referenced model. You could also use arrays to define multiple fields in the relationship.</p>
<p>Many to many relationships require 3 models and define the attributes involved in the relationship:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasManyToMany</span><span class="p">(</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RobotsParts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;robots_id&quot;</span><span class="p">,</span> <span class="s2">&quot;parts_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="taking-advantage-of-relationships">
<h2>使用关系（Taking advantage of relationships）<a class="headerlink" href="#taking-advantage-of-relationships" title="永久链接至标题">¶</a></h2>
<p>When explicitly defining the relationships between models, it is easy to find related records for a particular record.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">robotsParts</span> <span class="k">as</span> <span class="nv">$robotPart</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$robotPart</span><span class="o">-&gt;</span><span class="na">parts</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Phalcon uses the magic methods <code class="code docutils literal"><span class="pre">__set</span></code>/<code class="code docutils literal"><span class="pre">__get</span></code>/<code class="code docutils literal"><span class="pre">__call</span></code> to store or retrieve related data using relationships.</p>
<p>By accessing an attribute with the same name as the relationship will retrieve all its related record(s).</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robot</span>       <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">robotsParts</span><span class="p">;</span> <span class="c1">// All the related records in RobotsParts</span>
</pre></div>
</div>
<p>Also, you can use a magic getter:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robot</span>       <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getRobotsParts</span><span class="p">();</span> <span class="c1">// All the related records in RobotsParts</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getRobotsParts</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">));</span> <span class="c1">// Passing parameters</span>
</pre></div>
</div>
<p>If the called method has a &#8220;get&#8221; prefix <a class="reference internal" href="../api/Phalcon_Mvc_Model.html"><span class="doc">Phalcon\Mvc\Model</span></a> will return a
<code class="code docutils literal"><span class="pre">findFirst()</span></code>/<code class="code docutils literal"><span class="pre">find()</span></code> result. The following example compares retrieving related results with using magic methods
and without:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robot</span>       <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// Robots model has a 1-n (hasMany)</span>
<span class="c1">// relationship to RobotsParts then</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">robotsParts</span><span class="p">;</span>

<span class="c1">// Only parts that match conditions</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getRobotsParts</span><span class="p">(</span><span class="s2">&quot;created_at = &#39;2015-03-15&#39;&quot;</span><span class="p">);</span>

<span class="c1">// Or using bound parameters</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">getRobotsParts</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="s2">&quot;created_at = :date:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bind&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s2">&quot;date&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;2015-03-15&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="nv">$robotPart</span>   <span class="o">=</span> <span class="nx">RobotsParts</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// RobotsParts model has a n-1 (belongsTo)</span>
<span class="c1">// relationship to RobotsParts then</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$robotPart</span><span class="o">-&gt;</span><span class="na">robots</span><span class="p">;</span>
</pre></div>
</div>
<p>Getting related records manually:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robot</span>       <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// Robots model has a 1-n (hasMany)</span>
<span class="c1">// relationship to RobotsParts, then</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nx">RobotsParts</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;robots_id = &#39;&quot;</span> <span class="o">.</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>

<span class="c1">// Only parts that match conditions</span>
<span class="nv">$robotsParts</span> <span class="o">=</span> <span class="nx">RobotsParts</span><span class="o">::</span><span class="na">find</span><span class="p">(</span>
    <span class="s2">&quot;robots_id = &#39;&quot;</span> <span class="o">.</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">&quot;&#39; AND created_at = &#39;2015-03-15&#39;&quot;</span>
<span class="p">);</span>

<span class="nv">$robotPart</span>   <span class="o">=</span> <span class="nx">RobotsParts</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// RobotsParts model has a n-1 (belongsTo)</span>
<span class="c1">// relationship to RobotsParts then</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="s2">&quot;id = &#39;&quot;</span> <span class="o">.</span> <span class="nv">$robotPart</span><span class="o">-&gt;</span><span class="na">robots_id</span> <span class="o">.</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The prefix &#8220;get&#8221; is used to <code class="code docutils literal"><span class="pre">find()</span></code>/<code class="code docutils literal"><span class="pre">findFirst()</span></code> related records. Depending on the type of relation it will use
&#8216;find&#8217; or &#8216;findFirst&#8217;:</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="73%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Description</th>
<th class="head">Implicit Method</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Belongs-To</td>
<td>Returns a model instance of the related record directly</td>
<td>findFirst</td>
</tr>
<tr class="row-odd"><td>Has-One</td>
<td>Returns a model instance of the related record directly</td>
<td>findFirst</td>
</tr>
<tr class="row-even"><td>Has-Many</td>
<td>Returns a collection of model instances of the referenced model</td>
<td>find</td>
</tr>
<tr class="row-odd"><td>Has-Many-to-Many</td>
<td>Returns a collection of model instances of the referenced model, it implicitly does &#8216;inner joins&#8217; with the involved models</td>
<td>(complex query)</td>
</tr>
</tbody>
</table>
<p>You can also use &#8220;count&#8221; prefix to return an integer denoting the count of the related records:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robot</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">&quot;The robot has &quot;</span><span class="p">,</span> <span class="nv">$robot</span><span class="o">-&gt;</span><span class="na">countRobotsParts</span><span class="p">(),</span> <span class="s2">&quot; parts</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="aliasing-relationships">
<h2>定义关系（Aliasing Relationships）<a class="headerlink" href="#aliasing-relationships" title="永久链接至标题">¶</a></h2>
<p>To explain better how aliases work, let&#8217;s check the following example:</p>
<p>The &#8220;robots_similar&#8221; table has the function to define what robots are similar to others:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mysql&gt; desc robots_similar<span class="p">;</span>
+-------------------+------------------+------+-----+---------+----------------+
<span class="p">|</span> Field             <span class="p">|</span> Type             <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+-------------------+------------------+------+-----+---------+----------------+
<span class="p">|</span> id                <span class="p">|</span> int<span class="o">(</span>10<span class="o">)</span> unsigned <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> robots_id         <span class="p">|</span> int<span class="o">(</span>10<span class="o">)</span> unsigned <span class="p">|</span> NO   <span class="p">|</span> MUL <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> similar_robots_id <span class="p">|</span> int<span class="o">(</span>10<span class="o">)</span> unsigned <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+-------------------+------------------+------+-----+---------+----------------+
<span class="m">3</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</pre></div>
</div>
<p>Both &#8220;robots_id&#8221; and &#8220;similar_robots_id&#8221; have a relation to the model Robots:</p>
<img class="align-center" src="../static/img/eer-2.png"><p>A model that maps this table and its relationships is the following:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">RobotsSimilar</span> <span class="k">extends</span> <span class="nx">Phalcon\Mvc\Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s1">&#39;robots_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Robots&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s1">&#39;similar_robots_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Robots&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Since both relations point to the same model (Robots), obtain the records related to the relationship could not be clear:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robotsSimilar</span> <span class="o">=</span> <span class="nx">RobotsSimilar</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">// Returns the related record based on the column (robots_id)</span>
<span class="c1">// Also as is a belongsTo it&#39;s only returning one record</span>
<span class="c1">// but the name &#39;getRobots&#39; seems to imply that return more than one</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$robotsSimilar</span><span class="o">-&gt;</span><span class="na">getRobots</span><span class="p">();</span>

<span class="c1">// but, how to get the related record based on the column (similar_robots_id)</span>
<span class="c1">// if both relationships have the same name?</span>
</pre></div>
</div>
<p>The aliases allow us to rename both relationships to solve these problems:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RobotsSimilar</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span>
            <span class="s1">&#39;robots_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Robots&#39;</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;alias&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Robot&#39;</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span>
            <span class="s1">&#39;similar_robots_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Robots&#39;</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;alias&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;SimilarRobot&#39;</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With the aliasing we can get the related records easily:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robotsSimilar</span> <span class="o">=</span> <span class="nx">RobotsSimilar</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">// Returns the related record based on the column (robots_id)</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$robotsSimilar</span><span class="o">-&gt;</span><span class="na">getRobot</span><span class="p">();</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$robotsSimilar</span><span class="o">-&gt;</span><span class="na">robot</span><span class="p">;</span>

<span class="c1">// Returns the related record based on the column (similar_robots_id)</span>
<span class="nv">$similarRobot</span> <span class="o">=</span> <span class="nv">$robotsSimilar</span><span class="o">-&gt;</span><span class="na">getSimilarRobot</span><span class="p">();</span>
<span class="nv">$similarRobot</span> <span class="o">=</span> <span class="nv">$robotsSimilar</span><span class="o">-&gt;</span><span class="na">similarRobot</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="getters-magic-getters-vs-explicit-methods">
<h2>魔术方法 Getters 对比显示方法（Magic Getters vs. Explicit methods）<a class="headerlink" href="#getters-magic-getters-vs-explicit-methods" title="永久链接至标题">¶</a></h2>
<p>Most IDEs and editors with auto-completion capabilities can not infer the correct types when using magic getters,
instead of use the magic getters you can optionally define those methods explicitly with the corresponding
docblocks helping the IDE to produce a better auto-completion:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;RobotsParts&quot;</span><span class="p">,</span> <span class="s2">&quot;robots_id&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Return the related &quot;robots parts&quot;</span>
<span class="sd">     *</span>
<span class="sd">     * @return \RobotsParts[]</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRobotsParts</span><span class="p">(</span><span class="nv">$parameters</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRelated</span><span class="p">(</span><span class="s1">&#39;RobotsParts&#39;</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="virtual-foreign-keys">
<h2>虚拟外键（Virtual Foreign Keys）<a class="headerlink" href="#virtual-foreign-keys" title="永久链接至标题">¶</a></h2>
<p>By default, relationships do not act like database foreign keys, that is, if you try to insert/update a value without having a valid
value in the referenced model, Phalcon will not produce a validation message. You can modify this behavior by adding a fourth parameter
when defining a relationship.</p>
<p>The RobotsPart model can be changed to demonstrate this feature:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RobotsParts</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$robots_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$parts_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span>
            <span class="s2">&quot;robots_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Robots&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;foreignKey&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span>
            <span class="s2">&quot;parts_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;foreignKey&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s2">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;The part_id does not exist on the Parts model&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you alter a <code class="code docutils literal"><span class="pre">belongsTo()</span></code> relationship to act as foreign key, it will validate that the values inserted/updated on those fields have a
valid value on the referenced model. Similarly, if a <code class="code docutils literal"><span class="pre">hasMany()</span></code>/<code class="code docutils literal"><span class="pre">hasOne()</span></code> is altered it will validate that the records cannot be deleted
if that record is used on a referenced model.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Parts</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RobotsParts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parts_id&quot;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;foreignKey&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s2">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;The part cannot be deleted because other robots are using it&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A virtual foreign key can be set up to allow null values as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RobotsParts</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$robots_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$parts_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span>
            <span class="s2">&quot;parts_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s2">&quot;foreignKey&quot;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s2">&quot;allowNulls&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span>    <span class="o">=&gt;</span> <span class="s2">&quot;The part_id does not exist on the Parts model&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cascade-restrict-actions">
<h2>级联与限制动作（Cascade/Restrict actions）<a class="headerlink" href="#cascade-restrict-actions" title="永久链接至标题">¶</a></h2>
<p>Relationships that act as virtual foreign keys by default restrict the creation/update/deletion of records
to maintain the integrity of data:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Store\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model\Relation</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span>
            <span class="s1">&#39;id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Store\\Models\\Parts&#39;</span><span class="p">,</span>
            <span class="s1">&#39;robots_id&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;foreignKey&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nx">Relation</span><span class="o">::</span><span class="na">ACTION_CASCADE</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above code set up to delete all the referenced records (parts) if the master record (robot) is deleted.</p>
</div>
<div class="section" id="storing-related-records">
<h2>存储关系记录（Storing related records）<a class="headerlink" href="#storing-related-records" title="永久链接至标题">¶</a></h2>
<p>Magic properties can be used to store a records and its related properties:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// Create an artist</span>
<span class="nv">$artist</span>          <span class="o">=</span> <span class="k">new</span> <span class="nx">Artists</span><span class="p">();</span>
<span class="nv">$artist</span><span class="o">-&gt;</span><span class="na">name</span>    <span class="o">=</span> <span class="s1">&#39;Shinichi Osawa&#39;</span><span class="p">;</span>
<span class="nv">$artist</span><span class="o">-&gt;</span><span class="na">country</span> <span class="o">=</span> <span class="s1">&#39;Japan&#39;</span><span class="p">;</span>

<span class="c1">// Create an album</span>
<span class="nv">$album</span>         <span class="o">=</span> <span class="k">new</span> <span class="nx">Albums</span><span class="p">();</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">name</span>   <span class="o">=</span> <span class="s1">&#39;The One&#39;</span><span class="p">;</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">artist</span> <span class="o">=</span> <span class="nv">$artist</span><span class="p">;</span> <span class="c1">// Assign the artist</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">year</span>   <span class="o">=</span> <span class="mi">2008</span><span class="p">;</span>

<span class="c1">// Save both records</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</pre></div>
</div>
<p>Saving a record and its related records in a has-many relation:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// Get an existing artist</span>
<span class="nv">$artist</span> <span class="o">=</span> <span class="nx">Artists</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="s1">&#39;name = &quot;Shinichi Osawa&quot;&#39;</span><span class="p">);</span>

<span class="c1">// Create an album</span>
<span class="nv">$album</span>         <span class="o">=</span> <span class="k">new</span> <span class="nx">Albums</span><span class="p">();</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">name</span>   <span class="o">=</span> <span class="s1">&#39;The One&#39;</span><span class="p">;</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">artist</span> <span class="o">=</span> <span class="nv">$artist</span><span class="p">;</span>

<span class="nv">$songs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="c1">// Create a first song</span>
<span class="nv">$songs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="o">=</span> <span class="k">new</span> <span class="nx">Songs</span><span class="p">();</span>
<span class="nv">$songs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">name</span>     <span class="o">=</span> <span class="s1">&#39;Star Guitar&#39;</span><span class="p">;</span>
<span class="nv">$songs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">duration</span> <span class="o">=</span> <span class="s1">&#39;5:54&#39;</span><span class="p">;</span>

<span class="c1">// Create a second song</span>
<span class="nv">$songs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>           <span class="o">=</span> <span class="k">new</span> <span class="nx">Songs</span><span class="p">();</span>
<span class="nv">$songs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">name</span>     <span class="o">=</span> <span class="s1">&#39;Last Days&#39;</span><span class="p">;</span>
<span class="nv">$songs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">duration</span> <span class="o">=</span> <span class="s1">&#39;4:29&#39;</span><span class="p">;</span>

<span class="c1">// Assign the songs array</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">songs</span> <span class="o">=</span> <span class="nv">$songs</span><span class="p">;</span>

<span class="c1">// Save the album + its songs</span>
<span class="nv">$album</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</pre></div>
</div>
<p>Saving the album and the artist at the same time implicitly makes use of a transaction so if anything
goes wrong with saving the related records, the parent will not be saved either. Messages are
passed back to the user for information regarding any errors.</p>
<p>Note: Adding related entities by overloading the following methods is not possible:</p>
<blockquote>
<div><ul class="simple">
<li><code class="code docutils literal"><span class="pre">Phalcon\Mvc\Model::beforeSave()</span></code></li>
<li><code class="code docutils literal"><span class="pre">Phalcon\Mvc\Model::beforeCreate()</span></code></li>
<li><code class="code docutils literal"><span class="pre">Phalcon\Mvc\Model::beforeUpdate()</span></code></li>
</ul>
</div></blockquote>
<p>You need to overload <code class="code docutils literal"><span class="pre">Phalcon\Mvc\Model::save()</span></code> for this to work from within a model.</p>
</div>
<div class="section" id="operations-over-resultsets">
<h2>在结果集中操作（Operations over Resultsets）<a class="headerlink" href="#operations-over-resultsets" title="永久链接至标题">¶</a></h2>
<p>If a resultset is composed of complete objects, the resultset is in the ability to perform operations on the records obtained in a simple manner:</p>
</div>
<div class="section" id="updating-related-records">
<h2>更新关联表记录（Updating related records）<a class="headerlink" href="#updating-related-records" title="永久链接至标题">¶</a></h2>
<p>Instead of doing this:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robots</span><span class="o">-&gt;</span><span class="na">getParts</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$part</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$part</span><span class="o">-&gt;</span><span class="na">stock</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="nv">$part</span><span class="o">-&gt;</span><span class="na">updated_at</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$part</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">()</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$part</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$message</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>you can do this:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robots</span><span class="o">-&gt;</span><span class="na">getParts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;stock&#39;</span>      <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;updated_at&#39;</span> <span class="o">=&gt;</span> <span class="nb">time</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>&#8216;update&#8217; also accepts an anonymous function to filter what records must be updated:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;stock&#39;</span>      <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;updated_at&#39;</span> <span class="o">=&gt;</span> <span class="nb">time</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">// Update all the parts except those whose type is basic</span>
<span class="nv">$robots</span><span class="o">-&gt;</span><span class="na">getParts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$part</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$part</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">==</span> <span class="nx">Part</span><span class="o">::</span><span class="na">TYPE_BASIC</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="deleting-related-records">
<h2>删除关联表记录（Deleting related records）<a class="headerlink" href="#deleting-related-records" title="永久链接至标题">¶</a></h2>
<p>Instead of doing this:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robots</span><span class="o">-&gt;</span><span class="na">getParts</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$part</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$part</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">()</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$part</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="nv">$message</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>you can do this:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="nv">$robots</span><span class="o">-&gt;</span><span class="na">getParts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</pre></div>
</div>
<p>&#8216;delete&#8217; also accepts an anonymous function to filter what records must be deleted:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1">// Delete only whose stock is greater or equal than zero</span>
<span class="nv">$robots</span><span class="o">-&gt;</span><span class="na">getParts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$part</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$part</span><span class="o">-&gt;</span><span class="na">stock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
</div>


			</div>
		  </div>
		</div>
	</div>
  </div>
</div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="models-metadata.html" title="模型元数据（Models Meta-Data）"
             >下一页</a> |</li>
        <li class="right" >
          <a href="models.html" title="使用模型（Working with Models）"
             >上一页</a> |</li> 
      </ul>
    </div>

<footer class="footer">
	<div class="container">
      <div class="row">
          <div class="col-xs-6 col-sm-3">
              <h4>Download</h4>
              <ul>
                  <li><a href="https://github.com/dreamsxin/cphalcon7/releases">安裝 Phalcon7</a></li>
              </ul>
          </div>
          <div class="col-xs-6 col-sm-3">
              <h4>Community</h4>
              <ul>
                  <li><a href="https://github.com/dreamsxin/cphalcon7">GitHub</a></li>
                  <li><a href="https://github.com/dreamsxin/cphalcon7/issues">Issue Tracker</a></li>
              </ul>
          </div>
          <div class="col-xs-6 col-sm-2">
              <h4>About</h4>
              <ul>
                  <li><a href="https://github.com/dreamsxin/cphalcon/wiki/%E6%8D%90%E8%B5%A0%EF%BC%88Donation%EF%BC%89">Donate</a></li>
              </ul>
          </div>
          <div id="license-spaccer" class="visible-xs"></div>
          <div id="license-wrapper" class="col-xs-12 col-sm-4">
              <p class="license">

                  Phalcon7 Framework is released under the <a href="https://github.com/dreamsxin/cphalcon7/blob/master/docs/LICENSE.md">new BSD license</a>.<br>
                  Except where otherwise noted, content on this site is licensed under the
                  <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License.</a>
              </p>
              <div class="design">
                  <span>Designed by:</span>

                  <a href="http://www.fog-city.net/" class="fogcity" target="_blank" title="Fog City Software"><span>Fog City Software</span></a>
              </div>
          </div>
      </div>
	</div>
</footer>
</body>
</html>